<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¢³æ’æ”¾æ•°æ®å¯è§†åŒ–å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .debug-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }
        
        .debug-log {
            background: #2d3748;
            color: #68d391;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .upload-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            color: white;
        }
        
        .import-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
            color: white;
        }
        
        .tab-button.active {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.8);
        }
        
        .tab-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px;
        }
        
        .file-input {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px dashed rgba(255, 255, 255, 0.5);
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            font-size: 16px;
            font-weight: 600;
        }
        
        .file-input-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
        }
        
        .test-button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
            color: white;
            margin: 10px;
        }
        
        .test-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
        }
        
        .validation-info {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .validation-error {
            background: rgba(255, 0, 0, 0.3);
            border: 2px solid rgba(255, 0, 0, 0.5);
        }
        
        .validation-success {
            background: rgba(0, 255, 0, 0.3);
            border: 2px solid rgba(0, 255, 0, 0.5);
        }
        
        .validation-warning {
            background: rgba(255, 193, 7, 0.3);
            border: 2px solid rgba(255, 193, 7, 0.5);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            color: white;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .data-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            margin-top: 30px;
        }
        
        .table-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .export-section {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            color: white;
        }
        
        .export-button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            font-size: 16px;
            font-weight: 600;
            color: white;
            text-decoration: none;
            margin: 0 10px;
        }
        
        .export-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
        }
        
        .filter-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            color: white;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .filter-group input, .filter-group select {
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 14px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .filter-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
            color: white;
        }
        
        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
        }
        
        .detailed-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            margin-top: 30px;
        }
        
        .table-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .table-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .pagination-btn {
            background: #667eea;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: #5a67d8;
        }
        
        .pagination-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .pagination-info {
            font-size: 14px;
            color: #666;
        }
        
        .detailed-table th {
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 12px;
            padding: 8px 6px;
        }
        
        .detailed-table td {
            font-size: 12px;
            padding: 8px 6px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .detailed-table td:hover {
            overflow: visible;
            white-space: normal;
            word-wrap: break-word;
        }
        
        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .success {
            background: #51cf66;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .import-tabs {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ± ç¢³æ’æ”¾æ•°æ®å¯è§†åŒ–åˆ†æ</h1>
        
        <!-- è°ƒè¯•ä¿¡æ¯åŒºåŸŸ -->
        <div class="debug-section">
            <h3>ğŸ”§ è°ƒè¯•ä¿¡æ¯</h3>
            <div class="debug-log" id="debugLog">ç­‰å¾…æ“ä½œ...</div>
            <button class="test-button" onclick="clearDebugLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>
        
        <div class="upload-section">
            <h2>æ•°æ®å¯¼å…¥</h2>
            <p>è¯·é€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶ç±»å‹</p>
            
            <div class="import-tabs">
                <button class="tab-button active" onclick="switchTab('json')">ğŸ“„ JSONæ–‡ä»¶</button>
                <button class="tab-button" onclick="switchTab('excel')">ğŸ“Š Excelæ–‡ä»¶</button>
            </div>
            
            <!-- JSONå¯¼å…¥ -->
            <div id="jsonTab" class="tab-content active">
                <h3>JSONæ–‡ä»¶å¯¼å…¥</h3>
                <p>è¯·é€‰æ‹©carbon_results_claude_4æ–‡ä»¶å¤¹ä¸­çš„JSONæ–‡ä»¶</p>
                <div class="file-input-wrapper">
                    <input type="file" id="jsonFileInput" class="file-input" accept=".json" multiple>
                    <label for="jsonFileInput" class="file-input-button">
                        ğŸ“ é€‰æ‹©JSONæ–‡ä»¶
                    </label>
                </div>
                <br>
                <button class="test-button" onclick="loadTestData()">ğŸ§ª åŠ è½½æµ‹è¯•æ•°æ®</button>
            </div>
            
            <!-- Excelå¯¼å…¥ -->
            <div id="excelTab" class="tab-content">
                <h3>Excelæ–‡ä»¶å¯¼å…¥</h3>
                <p>è¯·é€‰æ‹©ä¹‹å‰å¯¼å‡ºçš„Excelæ–‡ä»¶ï¼ˆåŒ…å«è¯¦ç»†æ•°æ®è¡¨ï¼‰</p>
                <div class="file-input-wrapper">
                    <input type="file" id="excelFileInput" class="file-input" accept=".xlsx,.xls">
                    <label for="excelFileInput" class="file-input-button">
                        ğŸ“Š é€‰æ‹©Excelæ–‡ä»¶
                    </label>
                </div>
                <div id="excelValidation" class="validation-info" style="display: none;"></div>
            </div>
            
            <div id="fileStatus"></div>
        </div>
        
        <div id="content" style="display: none;">
            <div class="export-section">
                <h3>ğŸ“Š å¯¼å‡ºæ•°æ®</h3>
                <p>å°†æ‰€æœ‰æ•°æ®å¯¼å‡ºä¸ºExcelè¡¨æ ¼</p>
                <button class="export-button" onclick="exportToExcel()">
                    ğŸ“‹ å¯¼å‡ºExcelè¡¨æ ¼
                </button>
            </div>
            <div class="stats-grid" id="statsGrid"></div>
            <div class="charts-grid" id="chartsGrid"></div>
            <div class="data-table" id="dataTable"></div>
            
            <div class="filter-section">
                <h3>ğŸ” æ•°æ®ç­›é€‰å™¨</h3>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>æ–‡ä»¶å</label>
                        <select id="fileFilter">
                            <option value="">å…¨éƒ¨æ–‡ä»¶</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>ææ–™ç±»å‹</label>
                        <select id="typeFilter">
                            <option value="">å…¨éƒ¨ç±»å‹</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>ææ–™åç§°</label>
                        <input type="text" id="materialFilter" placeholder="æœç´¢ææ–™åç§°...">
                    </div>
                    <div class="filter-group">
                        <label>æœ€å°æ’æ”¾é‡</label>
                        <input type="number" id="minEmissionsFilter" placeholder="kgCO2e">
                    </div>
                    <div class="filter-group">
                        <label>æœ€å¤§æ’æ”¾é‡</label>
                        <input type="number" id="maxEmissionsFilter" placeholder="kgCO2e">
                    </div>
                    <div class="filter-group">
                        <label>ææ–™ç±»åˆ«</label>
                        <select id="categoryFilter">
                            <option value="">å…¨éƒ¨ç±»åˆ«</option>
                        </select>
                    </div>
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn" onclick="applyFilters()">ğŸ” åº”ç”¨ç­›é€‰</button>
                    <button class="filter-btn" onclick="clearFilters()">ğŸ—‘ï¸ æ¸…é™¤ç­›é€‰</button>
                </div>
            </div>
            
            <div class="detailed-table" id="detailedDataTable">
                <div class="chart-title">ğŸ“‹ è¯¦ç»†åŸå§‹æ•°æ®</div>
                <div class="table-info">
                    <span id="recordCount">å…± 0 æ¡è®°å½•</span>
                    <span>
                        æ¯é¡µæ˜¾ç¤ºï¼š
                        <select id="pageSize" onchange="changePageSize()">
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                        </select>
                    </span>
                </div>
                <div class="table-wrapper">
                    <table id="detailsTable">
                        <thead>
                            <tr>
                                <th>æ–‡ä»¶å</th>
                                <th>Ref</th>
                                <th>ç±»å‹</th>
                                <th>ææ–™åç§°</th>
                                <th>åŒ¹é…ææ–™</th>
                                <th>ç½®ä¿¡åº¦</th>
                                <th>æ•°é‡</th>
                                <th>å•ä½</th>
                                <th>è°ƒæ•´æ•°é‡</th>
                                <th>æ’æ”¾å› å­</th>
                                <th>å› å­å•ä½</th>
                                <th>ææ–™ç±»åˆ«</th>
                                <th>æ’æ”¾é‡ (kgCO2e)</th>
                                <th>æ¨ç†è¿‡ç¨‹</th>
                                <th>å•ä½è½¬æ¢</th>
                                <th>è½¬æ¢å€æ•°</th>
                                <th>è½¬æ¢æ–¹æ³•</th>
                                <th>è½¬æ¢æ­¥éª¤</th>
                                <th>é”™è¯¯ä¿¡æ¯</th>
                            </tr>
                        </thead>
                        <tbody id="detailsTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="table-pagination">
                    <button class="pagination-btn" id="prevBtn" onclick="changePage(-1)">ä¸Šä¸€é¡µ</button>
                    <span class="pagination-info" id="pageInfo">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</span>
                    <button class="pagination-btn" id="nextBtn" onclick="changePage(1)">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let charts = {};
        let filteredData = [];
        let currentPage = 1;
        let pageSize = 25;
        let currentTab = 'json';

        // å®šä¹‰Excelæ–‡ä»¶çš„é¢„æœŸè¡¨å¤´
        const expectedExcelHeaders = [
            'æ–‡ä»¶å', 'æ€»æ’æ”¾é‡', 'material_index', 'ref', 'type', 'material', 
            'matched_material', 'confidence', 'reasoning', 'quantity', 'input_unit', 
            'adjusted_quantity', 'unit_conversion_needed', 'conversion_multiplier', 
            'conversion_method', 'conversion_steps', 'factor', 'factor_unit', 
            'material_category', 'emissions', 'error'
        ];

        // è°ƒè¯•æ—¥å¿—å‡½æ•°
        function debugLog(message) {
            const debugLogElement = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            debugLogElement.textContent += `[${timestamp}] ${message}\n`;
            debugLogElement.scrollTop = debugLogElement.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        function clearDebugLog() {
            document.getElementById('debugLog').textContent = 'æ—¥å¿—å·²æ¸…é™¤\n';
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            debugLog(`åˆ‡æ¢åˆ°${tabName}æ ‡ç­¾é¡µ`);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            currentTab = tabName;
        }

        // éªŒè¯Excelæ–‡ä»¶è¡¨å¤´
        function validateExcelHeaders(headers) {
            debugLog('éªŒè¯Excelæ–‡ä»¶è¡¨å¤´...');
            const missingHeaders = [];
            const extraHeaders = [];
            const availableHeaders = [];
            
            // æ£€æŸ¥ç¼ºå¤±çš„è¡¨å¤´
            expectedExcelHeaders.forEach(header => {
                if (!headers.includes(header)) {
                    missingHeaders.push(header);
                } else {
                    availableHeaders.push(header);
                }
            });
            
            // æ£€æŸ¥é¢å¤–çš„è¡¨å¤´
            headers.forEach(header => {
                if (!expectedExcelHeaders.includes(header)) {
                    extraHeaders.push(header);
                }
            });
            
            const validationResult = {
                isValid: missingHeaders.length === 0,
                canProceed: availableHeaders.length > 0, // åªè¦æœ‰å¯ç”¨è¡¨å¤´å°±å¯ä»¥ç»§ç»­
                missingHeaders: missingHeaders,
                extraHeaders: extraHeaders,
                availableHeaders: availableHeaders,
                message: ''
            };
            
            if (validationResult.isValid) {
                validationResult.message = 'âœ… Excelæ–‡ä»¶è¡¨å¤´éªŒè¯é€šè¿‡ï¼æ‰€æœ‰å¿…éœ€è¡¨å¤´éƒ½å­˜åœ¨ã€‚';
            } else if (validationResult.canProceed) {
                validationResult.message = `âš ï¸ Excelæ–‡ä»¶è¡¨å¤´éƒ¨åˆ†ç¼ºå¤±ï¼Œä½†å¯ä»¥ç»§ç»­å¤„ç†ï¼š\nâœ… å¯ç”¨è¡¨å¤´ (${availableHeaders.length}ä¸ª): ${availableHeaders.slice(0, 5).join(', ')}${availableHeaders.length > 5 ? '...' : ''}\nâŒ ç¼ºå¤±è¡¨å¤´ (${missingHeaders.length}ä¸ª): ${missingHeaders.slice(0, 5).join(', ')}${missingHeaders.length > 5 ? '...' : ''}${extraHeaders.length > 0 ? `\nğŸ“ é¢å¤–è¡¨å¤´: ${extraHeaders.slice(0, 3).join(', ')}${extraHeaders.length > 3 ? '...' : ''}` : ''}`;
            } else {
                validationResult.message = `âŒ Excelæ–‡ä»¶æ— æ³•å¤„ç†ï¼šæ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆçš„è¡¨å¤´\nå½“å‰è¡¨å¤´: ${headers.join(', ')}`;
            }
            
            debugLog(validationResult.message);
            return validationResult;
        }

        // å¤„ç†Excelæ–‡ä»¶å¯¼å…¥
        function handleExcelFile(file) {
            debugLog(`å¼€å§‹å¤„ç†Excelæ–‡ä»¶: ${file.name}`);
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    debugLog(`Excelå·¥ä½œç°¿è¯»å–æˆåŠŸï¼Œå·¥ä½œè¡¨æ•°é‡: ${workbook.SheetNames.length}`);
                    debugLog(`å·¥ä½œè¡¨åç§°: ${workbook.SheetNames.join(', ')}`);
                    
                    // æŸ¥æ‰¾è¯¦ç»†æ•°æ®å·¥ä½œè¡¨
                    let detailSheet = null;
                    let sheetName = '';
                    
                    if (workbook.SheetNames.includes('è¯¦ç»†æ•°æ®')) {
                        detailSheet = workbook.Sheets['è¯¦ç»†æ•°æ®'];
                        sheetName = 'è¯¦ç»†æ•°æ®';
                    } else if (workbook.SheetNames.length > 0) {
                        detailSheet = workbook.Sheets[workbook.SheetNames[0]];
                        sheetName = workbook.SheetNames[0];
                    }
                    
                    if (!detailSheet) {
                        throw new Error('æ‰¾ä¸åˆ°å¯ç”¨çš„å·¥ä½œè¡¨');
                    }
                    
                    debugLog(`ä½¿ç”¨å·¥ä½œè¡¨: ${sheetName}`);
                    
                    // è½¬æ¢ä¸ºJSONæ•°æ®
                    const jsonData = XLSX.utils.sheet_to_json(detailSheet);
                    debugLog(`Excelæ•°æ®è½¬æ¢å®Œæˆï¼Œè®°å½•æ•°: ${jsonData.length}`);
                    
                    if (jsonData.length === 0) {
                        throw new Error('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®');
                    }
                    
                    // éªŒè¯è¡¨å¤´
                    const headers = Object.keys(jsonData[0]);
                    const validation = validateExcelHeaders(headers);
                    
                    const validationDiv = document.getElementById('excelValidation');
                    validationDiv.style.display = 'block';
                    
                    if (validation.isValid) {
                        validationDiv.className = 'validation-info validation-success';
                    } else if (validation.canProceed) {
                        validationDiv.className = 'validation-info' + ' ' + 'validation-warning';
                        validationDiv.style.background = 'rgba(255, 193, 7, 0.3)';
                        validationDiv.style.border = '2px solid rgba(255, 193, 7, 0.5)';
                    } else {
                        validationDiv.className = 'validation-info validation-error';
                    }
                    
                    validationDiv.innerHTML = validation.message.replace(/\n/g, '<br>');
                    
                    if (!validation.canProceed) {
                        debugLog('Excelæ–‡ä»¶è¡¨å¤´éªŒè¯å¤±è´¥ï¼Œæ— æ³•ç»§ç»­å¤„ç†');
                        return;
                    }
                    
                    if (!validation.isValid) {
                        debugLog('Excelæ–‡ä»¶è¡¨å¤´éƒ¨åˆ†ç¼ºå¤±ï¼Œä½†ç»§ç»­å¤„ç†å¯ç”¨æ•°æ®...');
                    }
                    
                    // å°†Excelæ•°æ®è½¬æ¢ä¸ºå†…éƒ¨æ•°æ®æ ¼å¼
                    const convertedData = convertExcelToInternalFormat(jsonData);
                    allData = convertedData;
                    
                    debugLog(`Excelæ•°æ®å¤„ç†å®Œæˆï¼Œè½¬æ¢ä¸º ${allData.length} ä¸ªæ–‡ä»¶çš„æ•°æ®`);
                    processAllData();
                    
                } catch (error) {
                    debugLog(`å¤„ç†Excelæ–‡ä»¶æ—¶å‡ºé”™: ${error.message}`);
                    document.getElementById('fileStatus').innerHTML = 
                        `<div class="error">Excelæ–‡ä»¶å¤„ç†å¤±è´¥: ${error.message}</div>`;
                }
            };
            
            reader.onerror = function(error) {
                debugLog(`Excelæ–‡ä»¶è¯»å–å¤±è´¥: ${error}`);
                document.getElementById('fileStatus').innerHTML = 
                    `<div class="error">Excelæ–‡ä»¶è¯»å–å¤±è´¥</div>`;
            };
            
            reader.readAsArrayBuffer(file);
        }

        // å°†Excelæ•°æ®è½¬æ¢ä¸ºå†…éƒ¨æ•°æ®æ ¼å¼
        function convertExcelToInternalFormat(excelData) {
            debugLog('å°†Excelæ•°æ®è½¬æ¢ä¸ºå†…éƒ¨æ ¼å¼...');
            
            const fileMap = new Map();
            
            excelData.forEach((row, index) => {
                // å®‰å…¨è·å–å­—æ®µå€¼ï¼Œå¦‚æœå­—æ®µä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤å€¼
                const filename = row['æ–‡ä»¶å'] || `unknown_${index}.json`;
                const totalEmissions = parseFloat(row['æ€»æ’æ”¾é‡']) || 0;
                
                if (!fileMap.has(filename)) {
                    fileMap.set(filename, {
                        filename: filename,
                        data: {
                            total_emissions: totalEmissions,
                            details: []
                        }
                    });
                }
                
                // æ„å»ºdetailå¯¹è±¡ï¼Œå¤„ç†å¯èƒ½ç¼ºå¤±çš„å­—æ®µ
                const detail = {
                    material_index: row['material_index'] !== undefined ? row['material_index'] : index,
                    ref: row['ref'] !== undefined ? parseFloat(row['ref']) || '' : '',
                    type: row['type'] || '',
                    material: row['material'] || '',
                    matched_material: row['matched_material'] || '',
                    confidence: row['confidence'] || '',
                    reasoning: row['reasoning'] || '',
                    quantity: row['quantity'] !== undefined ? parseFloat(row['quantity']) || 0 : 0,
                    input_unit: row['input_unit'] || '',
                    adjusted_quantity: row['adjusted_quantity'] !== undefined ? parseFloat(row['adjusted_quantity']) || 0 : 0,
                    unit_conversion_needed: row['unit_conversion_needed'] === 'æ˜¯' || row['unit_conversion_needed'] === true || false,
                    conversion_multiplier: row['conversion_multiplier'] !== undefined ? parseFloat(row['conversion_multiplier']) || 1 : 1,
                    conversion_method: row['conversion_method'] || '',
                    conversion_steps: row['conversion_steps'] || '',
                    factor: row['factor'] !== undefined ? parseFloat(row['factor']) || 0 : 0,
                    factor_unit: row['factor_unit'] || '',
                    material_category: row['material_category'] || '',
                    emissions: row['emissions'] !== undefined ? parseFloat(row['emissions']) || 0 : 0,
                    error: row['error'] || ''
                };
                
                // å¦‚æœemissionsä¸º0ä½†æœ‰factorå’Œquantityï¼Œå°è¯•è®¡ç®—
                if (detail.emissions === 0 && detail.factor > 0 && detail.adjusted_quantity > 0) {
                    detail.emissions = detail.factor * detail.adjusted_quantity;
                    debugLog(`ä¸ºç¼ºå¤±çš„emissionså­—æ®µè®¡ç®—å€¼: ${detail.emissions} (${detail.factor} Ã— ${detail.adjusted_quantity})`);
                }
                
                fileMap.get(filename).data.details.push(detail);
            });
            
            // é‡æ–°è®¡ç®—æ¯ä¸ªæ–‡ä»¶çš„æ€»æ’æ”¾é‡ï¼ˆä»¥é˜²Excelä¸­çš„æ€»æ’æ”¾é‡ä¸å‡†ç¡®ï¼‰
            fileMap.forEach((fileData, filename) => {
                const calculatedTotal = fileData.data.details.reduce((sum, detail) => sum + (detail.emissions || 0), 0);
                if (Math.abs(fileData.data.total_emissions - calculatedTotal) > 1) { // å…è®¸1çš„è¯¯å·®
                    debugLog(`æ–‡ä»¶ ${filename} é‡æ–°è®¡ç®—æ€»æ’æ”¾é‡: ${calculatedTotal} (åŸå€¼: ${fileData.data.total_emissions})`);
                    fileData.data.total_emissions = calculatedTotal;
                }
            });
            
            const result = Array.from(fileMap.values());
            debugLog(`Excelæ•°æ®è½¬æ¢å®Œæˆ: ${result.length} ä¸ªæ–‡ä»¶ï¼Œå¤„ç†äº†å¯èƒ½ç¼ºå¤±çš„å­—æ®µ`);
            return result;
        }

        // åŠ è½½æµ‹è¯•æ•°æ®
        function loadTestData() {
            debugLog('åŠ è½½æµ‹è¯•æ•°æ®...');
            
            const testData = {
                "total_emissions": 1500000,
                "details": [
                    {
                        "material_index": 0,
                        "ref": 23.0,
                        "type": "Concrete",
                        "material": "Concrete Grade 20P/20",
                        "matched_material": "Concrete C20, Ordinary Portland Cement",
                        "confidence": "high",
                        "reasoning": "Material 0: Exact match for C20 concrete in Hong Kong",
                        "quantity": 141.0,
                        "input_unit": "Cube",
                        "adjusted_quantity": 141.0,
                        "unit_conversion_needed": false,
                        "conversion_multiplier": 1.0,
                        "conversion_method": "No conversion needed",
                        "conversion_steps": "N/A",
                        "factor": 309.75,
                        "factor_unit": "kgCO2e/m3",
                        "material_category": "concrete",
                        "emissions": 43674.75,
                        "error": ""
                    },
                    {
                        "material_index": 1,
                        "ref": 24.0,
                        "type": "Steel",
                        "material": "Steel Rebar Grade 460",
                        "matched_material": "Steel Reinforcement Bar",
                        "confidence": "high",
                        "reasoning": "Material 1: Standard steel rebar",
                        "quantity": 50.5,
                        "input_unit": "Ton",
                        "adjusted_quantity": 50.5,
                        "unit_conversion_needed": false,
                        "conversion_multiplier": 1.0,
                        "conversion_method": "No conversion needed",
                        "conversion_steps": "N/A",
                        "factor": 2280.0,
                        "factor_unit": "kgCO2e/Ton",
                        "material_category": "steel",
                        "emissions": 115140.0,
                        "error": ""
                    }
                ]
            };
            
            allData = [
                {
                    filename: "test_building_1.json",
                    data: testData
                },
                {
                    filename: "test_building_2.json", 
                    data: {
                        "total_emissions": 800000,
                        "details": [
                            {
                                "material_index": 0,
                                "ref": 1.0,
                                "type": "Aluminum",
                                "material": "Aluminum Window Frame",
                                "matched_material": "Aluminum Alloy",
                                "confidence": "medium",
                                "reasoning": "Standard aluminum for windows",
                                "quantity": 25.3,
                                "input_unit": "kg",
                                "adjusted_quantity": 25.3,
                                "unit_conversion_needed": false,
                                "conversion_multiplier": 1.0,
                                "conversion_method": "No conversion needed",
                                "conversion_steps": "N/A",
                                "factor": 8900.0,
                                "factor_unit": "kgCO2e/Ton",
                                "material_category": "metal",
                                "emissions": 225170.0,
                                "error": ""
                            }
                        ]
                    }
                }
            ];
            
            debugLog(`æµ‹è¯•æ•°æ®å·²åŠ è½½: ${allData.length} ä¸ªæ–‡ä»¶`);
            processAllData();
        }

        // å¤„ç†JSONæ–‡ä»¶é€‰æ‹©
        function handleJsonFiles(event) {
            debugLog('handleJsonFiles å‡½æ•°è¢«è°ƒç”¨');
            const files = event.target.files;
            const fileStatus = document.getElementById('fileStatus');
            
            debugLog(`é€‰æ‹©äº† ${files.length} ä¸ªJSONæ–‡ä»¶`);
            
            if (files.length === 0) {
                debugLog('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            fileStatus.innerHTML = `<p>æ­£åœ¨å¤„ç† ${files.length} ä¸ªJSONæ–‡ä»¶...</p>`;
            allData = [];
            
            let processedFiles = 0;
            
            Array.from(files).forEach((file, index) => {
                debugLog(`å¤„ç†JSONæ–‡ä»¶ ${index + 1}: ${file.name} (å¤§å°: ${file.size} å­—èŠ‚)`);
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        debugLog(`JSONæ–‡ä»¶ ${file.name} è¯»å–å®Œæˆï¼Œå¼€å§‹è§£æJSON...`);
                        const data = JSON.parse(e.target.result);
                        debugLog(`JSONæ–‡ä»¶ ${file.name} JSONè§£ææˆåŠŸ`);
                        
                        allData.push({
                            filename: file.name,
                            data: data
                        });
                        
                        processedFiles++;
                        debugLog(`å·²å¤„ç† ${processedFiles}/${files.length} ä¸ªJSONæ–‡ä»¶`);
                        
                        if (processedFiles === files.length) {
                            debugLog('æ‰€æœ‰JSONæ–‡ä»¶å¤„ç†å®Œæˆï¼Œå¼€å§‹æ•°æ®å¤„ç†...');
                            processAllData();
                        }
                    } catch (error) {
                        debugLog(`JSONæ–‡ä»¶ ${file.name} JSONè§£æå¤±è´¥: ${error.message}`);
                        fileStatus.innerHTML = `<div class="error">æ–‡ä»¶ ${file.name} è§£æå¤±è´¥: ${error.message}</div>`;
                    }
                };
                
                reader.onerror = function(error) {
                    debugLog(`JSONæ–‡ä»¶ ${file.name} è¯»å–å¤±è´¥: ${error}`);
                    fileStatus.innerHTML = `<div class="error">æ–‡ä»¶ ${file.name} è¯»å–å¤±è´¥</div>`;
                };
                
                reader.readAsText(file);
            });
        }

        // å¤„ç†Excelæ–‡ä»¶é€‰æ‹©
        function handleExcelFiles(event) {
            debugLog('handleExcelFiles å‡½æ•°è¢«è°ƒç”¨');
            const files = event.target.files;
            const fileStatus = document.getElementById('fileStatus');
            
            debugLog(`é€‰æ‹©äº† ${files.length} ä¸ªExcelæ–‡ä»¶`);
            
            if (files.length === 0) {
                debugLog('æ²¡æœ‰é€‰æ‹©Excelæ–‡ä»¶');
                return;
            }
            
            if (files.length > 1) {
                fileStatus.innerHTML = `<div class="error">è¯·åªé€‰æ‹©ä¸€ä¸ªExcelæ–‡ä»¶</div>`;
                return;
            }
            
            const file = files[0];
            fileStatus.innerHTML = `<p>æ­£åœ¨å¤„ç†Excelæ–‡ä»¶: ${file.name}...</p>`;
            
            handleExcelFile(file);
        }

        // å¤„ç†æ‰€æœ‰æ•°æ®
        function processAllData() {
            debugLog(`processAllData å¼€å§‹å¤„ç† ${allData.length} ä¸ªæ–‡ä»¶çš„æ•°æ®`);
            
            if (allData.length === 0) {
                debugLog('æ²¡æœ‰æ•°æ®éœ€è¦å¤„ç†');
                return;
            }
            
            try {
                debugLog('æ˜¾ç¤ºå†…å®¹åŒºåŸŸ...');
                document.getElementById('content').style.display = 'block';
                document.getElementById('fileStatus').innerHTML = `<div class="success">âœ… æˆåŠŸåŠ è½½ ${allData.length} ä¸ªæ–‡ä»¶</div>`;
                
                debugLog('åˆ›å»ºç»Ÿè®¡å¡ç‰‡...');
                createStatsCards();
                
                debugLog('åˆ›å»ºå›¾è¡¨...');
                createCharts();
                
                debugLog('åˆ›å»ºæ•°æ®è¡¨æ ¼...');
                createDataTable();
                
                debugLog('åˆå§‹åŒ–ç­›é€‰å™¨...');
                initializeFilters();
                
                debugLog('åŠ è½½è¯¦ç»†æ•°æ®...');
                loadDetailedData();
                
                debugLog('æ‰€æœ‰æ•°æ®å¤„ç†å®Œæˆ!');
            } catch (error) {
                debugLog(`å¤„ç†æ•°æ®æ—¶å‡ºé”™: ${error.message}`);
                console.error('å¤„ç†æ•°æ®æ—¶å‡ºé”™:', error);
                document.getElementById('fileStatus').innerHTML = `<div class="error">å¤„ç†æ•°æ®æ—¶å‡ºé”™: ${error.message}</div>`;
            }
        }

        function createStatsCards() {
            debugLog('åˆ›å»ºç»Ÿè®¡å¡ç‰‡...');
            const statsGrid = document.getElementById('statsGrid');
            
            try {
                let totalEmissions = 0;
                let totalMaterials = 0;
                let totalFiles = allData.length;
                let materialTypes = new Set();
                
                allData.forEach((fileData, index) => {
                    debugLog(`å¤„ç†æ–‡ä»¶ ${index + 1} ç»Ÿè®¡: ${fileData.filename}`);
                    
                    totalEmissions += fileData.data.total_emissions || 0;
                    totalMaterials += fileData.data.details ? fileData.data.details.length : 0;
                    
                    if (fileData.data.details) {
                        fileData.data.details.forEach(detail => {
                            if (detail.type) {
                                materialTypes.add(detail.type);
                            }
                        });
                    }
                });
                
                debugLog(`ç»Ÿè®¡ç»“æœ: æ€»æ’æ”¾=${totalEmissions}, æ€»ææ–™=${totalMaterials}, æ–‡ä»¶æ•°=${totalFiles}, ææ–™ç±»å‹æ•°=${materialTypes.size}`);
                
                const stats = [
                    { label: 'æ€»ç¢³æ’æ”¾é‡', value: (totalEmissions / 1000000).toFixed(2), unit: 'ç™¾ä¸‡ kgCO2e' },
                    { label: 'æ–‡ä»¶æ•°é‡', value: totalFiles, unit: 'ä¸ª' },
                    { label: 'ææ–™é¡¹ç›®æ€»æ•°', value: totalMaterials, unit: 'é¡¹' },
                    { label: 'ææ–™ç±»å‹', value: materialTypes.size, unit: 'ç§' }
                ];
                
                statsGrid.innerHTML = stats.map(stat => `
                    <div class="stat-card">
                        <div class="stat-value">${stat.value}</div>
                        <div class="stat-label">${stat.label} (${stat.unit})</div>
                    </div>
                `).join('');
                
                debugLog('ç»Ÿè®¡å¡ç‰‡åˆ›å»ºæˆåŠŸ');
            } catch (error) {
                debugLog(`åˆ›å»ºç»Ÿè®¡å¡ç‰‡æ—¶å‡ºé”™: ${error.message}`);
                statsGrid.innerHTML = `<div class="error">ç»Ÿè®¡å¡ç‰‡åˆ›å»ºå¤±è´¥: ${error.message}</div>`;
            }
        }

        function createCharts() {
            debugLog('åˆ›å»ºå›¾è¡¨...');
            const chartsGrid = document.getElementById('chartsGrid');
            
            try {
                chartsGrid.innerHTML = `
                    <div class="chart-container">
                        <div class="chart-title">å„æ–‡ä»¶ç¢³æ’æ”¾é‡å¯¹æ¯”</div>
                        <canvas id="emissionsChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">ææ–™ç±»å‹åˆ†å¸ƒ (æŒ‰typeåˆ†ç±»)</div>
                        <canvas id="materialChart"></canvas>
                    </div>
                    <div class="chart-container full-width">
                        <div class="chart-title">è¯¦ç»†ææ–™ç¢³æ’æ”¾åˆ†æ (Top 20)</div>
                        <canvas id="detailedChart"></canvas>
                    </div>
                `;
                
                createEmissionsChart();
                createMaterialTypeChart();
                createDetailedChart();
                
                debugLog('å›¾è¡¨åˆ›å»ºæˆåŠŸ');
            } catch (error) {
                debugLog(`åˆ›å»ºå›¾è¡¨æ—¶å‡ºé”™: ${error.message}`);
                chartsGrid.innerHTML = `<div class="error">å›¾è¡¨åˆ›å»ºå¤±è´¥: ${error.message}</div>`;
            }
        }

        function createEmissionsChart() {
            try {
                const ctx = document.getElementById('emissionsChart');
                if (!ctx) {
                    debugLog('æ‰¾ä¸åˆ°æ’æ”¾é‡å›¾è¡¨canvaså…ƒç´ ');
                    return;
                }
                
                const labels = allData.map(item => item.filename.replace('.json', ''));
                const data = allData.map(item => (item.data.total_emissions || 0) / 1000000);
                
                if (charts.emissions) charts.emissions.destroy();
                
                charts.emissions = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ç¢³æ’æ”¾é‡ (ç™¾ä¸‡ kgCO2e)',
                            data: data,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                
                debugLog('æ’æ”¾é‡å¯¹æ¯”å›¾è¡¨åˆ›å»ºæˆåŠŸ');
            } catch (error) {
                debugLog(`åˆ›å»ºæ’æ”¾é‡å›¾è¡¨æ—¶å‡ºé”™: ${error.message}`);
            }
        }

        function createMaterialTypeChart() {
            try {
                const ctx = document.getElementById('materialChart');
                if (!ctx) {
                    debugLog('æ‰¾ä¸åˆ°ææ–™ç±»å‹å›¾è¡¨canvaså…ƒç´ ');
                    return;
                }
                
                const materialStats = {};
                
                allData.forEach(fileData => {
                    if (fileData.data.details) {
                        fileData.data.details.forEach(detail => {
                            const type = detail.type || 'æœªçŸ¥';
                            materialStats[type] = (materialStats[type] || 0) + (detail.emissions || 0);
                        });
                    }
                });
                
                const labels = Object.keys(materialStats);
                const data = Object.values(materialStats).map(val => val / 1000000);
                
                const colors = [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                ];
                
                if (charts.material) charts.material.destroy();
                
                charts.material = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                
                debugLog('ææ–™ç±»å‹åˆ†å¸ƒå›¾è¡¨åˆ›å»ºæˆåŠŸ');
            } catch (error) {
                debugLog(`åˆ›å»ºææ–™ç±»å‹å›¾è¡¨æ—¶å‡ºé”™: ${error.message}`);
            }
        }

        function createDetailedChart() {
            try {
                const ctx = document.getElementById('detailedChart');
                if (!ctx) {
                    debugLog('æ‰¾ä¸åˆ°è¯¦ç»†åˆ†æå›¾è¡¨canvaså…ƒç´ ');
                    return;
                }
                
                const allDetails = [];
                allData.forEach(fileData => {
                    if (fileData.data.details) {
                        fileData.data.details.forEach(detail => {
                            allDetails.push({
                                ...detail,
                                filename: fileData.filename
                            });
                        });
                    }
                });
                
                allDetails.sort((a, b) => (b.emissions || 0) - (a.emissions || 0));
                const topDetails = allDetails.slice(0, 20);
                
                const labels = topDetails.map(detail => 
                    `${detail.material || detail.type || 'æœªçŸ¥'} (${detail.filename})`
                );
                const data = topDetails.map(detail => (detail.emissions || 0) / 1000000);
                
                if (charts.detailed) charts.detailed.destroy();
                
                charts.detailed = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ç¢³æ’æ”¾é‡ (ç™¾ä¸‡ kgCO2e)',
                            data: data,
                            backgroundColor: 'rgba(245, 87, 108, 0.8)',
                            borderColor: 'rgba(245, 87, 108, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
                debugLog('è¯¦ç»†ææ–™åˆ†æå›¾è¡¨åˆ›å»ºæˆåŠŸ');
            } catch (error) {
                debugLog(`åˆ›å»ºè¯¦ç»†åˆ†æå›¾è¡¨æ—¶å‡ºé”™: ${error.message}`);
            }
        }

        function createDataTable() {
            debugLog('åˆ›å»ºæ•°æ®è¡¨æ ¼...');
            const dataTable = document.getElementById('dataTable');
            
            try {
                const materialCategoryStats = {};
                allData.forEach(fileData => {
                    if (fileData.data.details) {
                        fileData.data.details.forEach(detail => {
                            const category = detail.type || 'æœªçŸ¥';
                            if (!materialCategoryStats[category]) {
                                materialCategoryStats[category] = {
                                    totalEmissions: 0,
                                    count: 0,
                                    totalQuantity: 0
                                };
                            }
                            materialCategoryStats[category].totalEmissions += detail.emissions || 0;
                            materialCategoryStats[category].count += 1;
                            materialCategoryStats[category].totalQuantity += detail.adjusted_quantity || detail.quantity || 0;
                        });
                    }
                });
                
                const sortedCategories = Object.entries(materialCategoryStats)
                    .sort(([,a], [,b]) => b.totalEmissions - a.totalEmissions);
                
                const summaryData = allData.map(fileData => ({
                    filename: fileData.filename,
                    totalEmissions: fileData.data.total_emissions || 0,
                    materialCount: fileData.data.details ? fileData.data.details.length : 0,
                    avgEmissions: fileData.data.details ? 
                        (fileData.data.total_emissions || 0) / fileData.data.details.length : 0
                }));
                
                const grandTotalEmissions = summaryData.reduce((sum, item) => sum + item.totalEmissions, 0);
                
                dataTable.innerHTML = `
                    <div class="chart-title">ææ–™ç±»å‹ç¢³æ’æ”¾æ±‡æ€» (æŒ‰typeåˆ†ç±»)</div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>ææ–™ç±»å‹ (type)</th>
                                    <th>æ€»æ’æ”¾é‡ (kgCO2e)</th>
                                    <th>ææ–™é¡¹æ•°</th>
                                    <th>å¹³å‡æ’æ”¾é‡ (kgCO2e)</th>
                                    <th>æ’æ”¾å æ¯”</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedCategories.map(([category, stats]) => {
                                    const totalEmissions = allData.reduce((sum, fileData) => 
                                        sum + (fileData.data.total_emissions || 0), 0);
                                    const percentage = ((stats.totalEmissions / totalEmissions) * 100).toFixed(1);
                                    return `
                                        <tr>
                                            <td><strong>${category}</strong></td>
                                            <td>${stats.totalEmissions.toLocaleString()}</td>
                                            <td>${stats.count}</td>
                                            <td>${(stats.totalEmissions / stats.count).toLocaleString()}</td>
                                            <td>${percentage}%</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="chart-title" style="margin-top: 40px;">æ–‡ä»¶è¯¦ç»†æ•°æ®æ±‡æ€»</div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>æ–‡ä»¶å</th>
                                    <th>æ€»æ’æ”¾é‡ (kgCO2e)</th>
                                    <th>ææ–™é¡¹æ•°</th>
                                    <th>å¹³å‡æ’æ”¾é‡ (kgCO2e)</th>
                                    <th>æ’æ”¾å æ¯”</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${summaryData.map(row => {
                                    const percentage = grandTotalEmissions > 0 ? 
                                        ((row.totalEmissions / grandTotalEmissions) * 100).toFixed(1) : '0.0';
                                    return `
                                        <tr>
                                            <td>${row.filename}</td>
                                            <td>${row.totalEmissions.toLocaleString()}</td>
                                            <td>${row.materialCount}</td>
                                            <td>${row.avgEmissions.toLocaleString()}</td>
                                            <td>${percentage}%</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                debugLog('æ•°æ®è¡¨æ ¼åˆ›å»ºæˆåŠŸ');
            } catch (error) {
                debugLog(`åˆ›å»ºæ•°æ®è¡¨æ ¼æ—¶å‡ºé”™: ${error.message}`);
                dataTable.innerHTML = `<div class="error">æ•°æ®è¡¨æ ¼åˆ›å»ºå¤±è´¥: ${error.message}</div>`;
            }
        }

        function initializeFilters() {
            debugLog('åˆå§‹åŒ–ç­›é€‰å™¨...');
            try {
                const fileFilter = document.getElementById('fileFilter');
                const typeFilter = document.getElementById('typeFilter');
                const categoryFilter = document.getElementById('categoryFilter');
                
                const files = new Set();
                const types = new Set();
                const categories = new Set();
                
                allData.forEach(fileData => {
                    files.add(fileData.filename);
                    if (fileData.data.details) {
                        fileData.data.details.forEach(detail => {
                            if (detail.type) types.add(detail.type);
                            if (detail.material_category) categories.add(detail.material_category);
                        });
                    }
                });
                
                fileFilter.innerHTML = '<option value="">å…¨éƒ¨æ–‡ä»¶</option>' + 
                    Array.from(files).sort().map(file => 
                        `<option value="${file}">${file}</option>`
                    ).join('');
                
                typeFilter.innerHTML = '<option value="">å…¨éƒ¨ç±»å‹</option>' + 
                    Array.from(types).sort().map(type => 
                        `<option value="${type}">${type}</option>`
                    ).join('');
                
                categoryFilter.innerHTML = '<option value="">å…¨éƒ¨ç±»åˆ«</option>' + 
                    Array.from(categories).sort().map(category => 
                        `<option value="${category}">${category}</option>`
                    ).join('');
                
                debugLog('ç­›é€‰å™¨åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                debugLog(`åˆå§‹åŒ–ç­›é€‰å™¨æ—¶å‡ºé”™: ${error.message}`);
            }
        }

        function loadDetailedData() {
            debugLog('åŠ è½½è¯¦ç»†æ•°æ®...');
            try {
                const allDetails = [];
                allData.forEach(fileData => {
                    if (fileData.data.details) {
                        fileData.data.details.forEach((detail, index) => {
                            allDetails.push({
                                ...detail,
                                filename: fileData.filename,
                                material_index: detail.material_index || index
                            });
                        });
                    }
                });
                
                filteredData = allDetails;
                currentPage = 1;
                renderDetailedTable();
                
                debugLog(`è¯¦ç»†æ•°æ®åŠ è½½æˆåŠŸ: ${allDetails.length} æ¡è®°å½•`);
            } catch (error) {
                debugLog(`åŠ è½½è¯¦ç»†æ•°æ®æ—¶å‡ºé”™: ${error.message}`);
            }
        }

        function applyFilters() {
            debugLog('åº”ç”¨ç­›é€‰æ¡ä»¶...');
            try {
                const fileFilter = document.getElementById('fileFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;
                const materialFilter = document.getElementById('materialFilter').value.toLowerCase();
                const minEmissions = parseFloat(document.getElementById('minEmissionsFilter').value) || 0;
                const maxEmissions = parseFloat(document.getElementById('maxEmissionsFilter').value) || Infinity;
                const categoryFilter = document.getElementById('categoryFilter').value;
                
                const allDetails = [];
                allData.forEach(fileData => {
                    if (fileData.data.details) {
                        fileData.data.details.forEach((detail, index) => {
                            allDetails.push({
                                ...detail,
                                filename: fileData.filename,
                                material_index: detail.material_index || index
                            });
                        });
                    }
                });
                
                filteredData = allDetails.filter(detail => {
                    return (
                        (!fileFilter || detail.filename === fileFilter) &&
                        (!typeFilter || detail.type === typeFilter) &&
                        (!materialFilter || (detail.material || '').toLowerCase().includes(materialFilter)) &&
                        (detail.emissions || 0) >= minEmissions &&
                        (detail.emissions || 0) <= maxEmissions &&
                        (!categoryFilter || detail.material_category === categoryFilter)
                    );
                });
                
                currentPage = 1;
                renderDetailedTable();
                
                debugLog(`ç­›é€‰å®Œæˆ: ${filteredData.length} æ¡è®°å½•ç¬¦åˆæ¡ä»¶`);
            } catch (error) {
                debugLog(`åº”ç”¨ç­›é€‰æ—¶å‡ºé”™: ${error.message}`);
            }
        }

        function clearFilters() {
            debugLog('æ¸…é™¤ç­›é€‰æ¡ä»¶...');
            try {
                document.getElementById('fileFilter').value = '';
                document.getElementById('typeFilter').value = '';
                document.getElementById('materialFilter').value = '';
                document.getElementById('minEmissionsFilter').value = '';
                document.getElementById('maxEmissionsFilter').value = '';
                document.getElementById('categoryFilter').value = '';
                
                loadDetailedData();
                debugLog('ç­›é€‰æ¡ä»¶å·²æ¸…é™¤');
            } catch (error) {
                debugLog(`æ¸…é™¤ç­›é€‰æ—¶å‡ºé”™: ${error.message}`);
            }
        }

        function renderDetailedTable() {
            try {
                const tbody = document.getElementById('detailsTableBody');
                const recordCount = document.getElementById('recordCount');
                const pageInfo = document.getElementById('pageInfo');
                
                const totalPages = Math.ceil(filteredData.length / pageSize);
                const startIndex = (currentPage - 1) * pageSize;
                const endIndex = Math.min(startIndex + pageSize, filteredData.length);
                const currentData = filteredData.slice(startIndex, endIndex);
                
                recordCount.textContent = `å…± ${filteredData.length} æ¡è®°å½•`;
                pageInfo.textContent = `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ`;
                
                document.getElementById('prevBtn').disabled = currentPage <= 1;
                document.getElementById('nextBtn').disabled = currentPage >= totalPages;
                
                tbody.innerHTML = currentData.map(detail => `
                    <tr>
                        <td title="${detail.filename}">${detail.filename}</td>
                        <td>${detail.ref || ''}</td>
                        <td>${detail.type || ''}</td>
                        <td title="${detail.material || ''}">${detail.material || ''}</td>
                        <td title="${detail.matched_material || ''}">${detail.matched_material || ''}</td>
                        <td>${detail.confidence || ''}</td>
                        <td>${detail.quantity || ''}</td>
                        <td>${detail.input_unit || ''}</td>
                        <td>${detail.adjusted_quantity || ''}</td>
                        <td>${detail.factor || ''}</td>
                        <td>${detail.factor_unit || ''}</td>
                        <td>${detail.material_category || ''}</td>
                        <td>${(detail.emissions || 0).toLocaleString()}</td>
                        <td title="${detail.reasoning || ''}" style="max-width: 150px;">${detail.reasoning || ''}</td>
                        <td>${detail.unit_conversion_needed ? 'æ˜¯' : 'å¦'}</td>
                        <td>${detail.conversion_multiplier || ''}</td>
                        <td title="${detail.conversion_method || ''}">${detail.conversion_method || ''}</td>
                        <td title="${detail.conversion_steps || ''}" style="max-width: 100px;">${detail.conversion_steps || ''}</td>
                        <td title="${detail.error || ''}">${detail.error || ''}</td>
                    </tr>
                `).join('');
                
                debugLog(`è¯¦ç»†è¡¨æ ¼æ¸²æŸ“æˆåŠŸ: æ˜¾ç¤ºç¬¬ ${currentPage} é¡µï¼Œ${currentData.length} æ¡è®°å½•`);
            } catch (error) {
                debugLog(`æ¸²æŸ“è¯¦ç»†è¡¨æ ¼æ—¶å‡ºé”™: ${error.message}`);
            }
        }

        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            currentPage = 1;
            renderDetailedTable();
            debugLog(`é¡µé¢å¤§å°æ”¹å˜ä¸º: ${pageSize}`);
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            currentPage += direction;
            currentPage = Math.max(1, Math.min(currentPage, totalPages));
            renderDetailedTable();
            debugLog(`ç¿»é¡µåˆ°ç¬¬ ${currentPage} é¡µ`);
        }
        
        function exportToExcel() {
            debugLog('å¼€å§‹å¯¼å‡ºExcel...');
            if (allData.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ æ•°æ®æ–‡ä»¶');
                return;
            }
            
            try {
                const allDetails = [];
                
                allData.forEach(fileData => {
                    if (fileData.data.details) {
                        fileData.data.details.forEach(detail => {
                            allDetails.push({
                                'æ–‡ä»¶å': fileData.filename,
                                'æ€»æ’æ”¾é‡': fileData.data.total_emissions || 0,
                                'material_index': detail.material_index || '',
                                'ref': detail.ref || '',
                                'type': detail.type || '',
                                'material': detail.material || '',
                                'matched_material': detail.matched_material || '',
                                'confidence': detail.confidence || '',
                                'reasoning': detail.reasoning || '',
                                'quantity': detail.quantity || '',
                                'input_unit': detail.input_unit || '',
                                'adjusted_quantity': detail.adjusted_quantity || '',
                                'unit_conversion_needed': detail.unit_conversion_needed || '',
                                'conversion_multiplier': detail.conversion_multiplier || '',
                                'conversion_method': detail.conversion_method || '',
                                'conversion_steps': detail.conversion_steps || '',
                                'factor': detail.factor || '',
                                'factor_unit': detail.factor_unit || '',
                                'material_category': detail.material_category || '',
                                'emissions': detail.emissions || '',
                                'error': detail.error || ''
                            });
                        });
                    }
                });
                
                const wb = XLSX.utils.book_new();
                const ws1 = XLSX.utils.json_to_sheet(allDetails);
                
                const colWidths = [
                    {wch: 15}, {wch: 15}, {wch: 12}, {wch: 8}, {wch: 12}, {wch: 30}, {wch: 35}, {wch: 10}, {wch: 50}, {wch: 10},
                    {wch: 12}, {wch: 15}, {wch: 18}, {wch: 18}, {wch: 25}, {wch: 60}, {wch: 10}, {wch: 15}, {wch: 18}, {wch: 15}, {wch: 10}
                ];
                ws1['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws1, "è¯¦ç»†æ•°æ®");
                
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 19).replace(/:/g, '-');
                const filename = `ç¢³æ’æ”¾æ•°æ®åˆ†æ_${timestamp}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                
                debugLog(`Excelæ–‡ä»¶å¯¼å‡ºæˆåŠŸ: ${filename}`);
                alert(`Excelæ–‡ä»¶å·²ç”Ÿæˆå¹¶ä¸‹è½½ï¼š${filename}`);
            } catch (error) {
                debugLog(`å¯¼å‡ºExcelæ—¶å‡ºé”™: ${error.message}`);
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·æŸ¥çœ‹è°ƒè¯•æ—¥å¿—');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            debugLog('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–åº”ç”¨...');
            
            // JSONæ–‡ä»¶è¾“å…¥ç›‘å¬å™¨
            const jsonFileInput = document.getElementById('jsonFileInput');
            if (jsonFileInput) {
                jsonFileInput.addEventListener('change', handleJsonFiles);
                debugLog('JSONæ–‡ä»¶è¾“å…¥ç›‘å¬å™¨å·²æ·»åŠ ');
            } else {
                debugLog('é”™è¯¯: æ‰¾ä¸åˆ°JSONæ–‡ä»¶è¾“å…¥å…ƒç´ ');
            }
            
            // Excelæ–‡ä»¶è¾“å…¥ç›‘å¬å™¨
            const excelFileInput = document.getElementById('excelFileInput');
            if (excelFileInput) {
                excelFileInput.addEventListener('change', handleExcelFiles);
                debugLog('Excelæ–‡ä»¶è¾“å…¥ç›‘å¬å™¨å·²æ·»åŠ ');
            } else {
                debugLog('é”™è¯¯: æ‰¾ä¸åˆ°Excelæ–‡ä»¶è¾“å…¥å…ƒç´ ');
            }
            
            debugLog('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>
            